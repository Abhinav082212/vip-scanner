<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VIP QR Scanner — AIML</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
  :root{--bg1:#e0c3fc;--bg2:#8ec5fc;--card:#fff;--ok:#16a34a;--bad:#ef4444;--muted:#334155;}
  html,body{height:100%;margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Poppins";background:linear-gradient(135deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box;}
  .card{width:420px;max-width:95vw;background:var(--card);border-radius:14px;padding:16px;box-shadow:0 14px 40px rgba(2,6,23,0.12);text-align:center;}
  h1{margin:0 0 8px;color:var(--muted);font-size:1.4rem;}
  video{width:100%;height:auto;border-radius:10px;background:#000;}
  #result{min-height:56px;margin-top:12px;padding:12px;border-radius:10px;background:#f8fafc;font-weight:700;color:#0f172a;}
  button{margin-top:12px;padding:10px 14px;border-radius:10px;border:0;background:#0b84ff;color:#fff;cursor:pointer;font-weight:700;}
  .ok{color:var(--ok);} .err{color:var(--bad);}
  pre{margin-top:10px;height:80px;overflow:auto;background:#f1f5f9;padding:8px;border-radius:8px;text-align:left;}
</style>
</head>
<body>
  <div class="card">
    <h1>🎩 VIP QR Scanner</h1>
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <div id="result">Press Start to scan a VIP QR.</div>
    <button id="startBtn">Start Scanner</button>
    <pre id="log"></pre>
  </div>

<script>
const BACKEND = "https://your-deployed-server.onrender.com"; // replace with your server URL or http://localhost:4000 for local testing
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const resultEl = document.getElementById('result');
const log = document.getElementById('log');
const startBtn = document.getElementById('startBtn');

let stream=null, scanning=false;

function logMsg(...a){ log.textContent = a.join(' ') + '\\n' + log.textContent; }
function show(msg, ok=null){
  resultEl.textContent = msg;
  resultEl.classList.remove('ok','err');
  if(ok===true) resultEl.classList.add('ok');
  else if(ok===false) resultEl.classList.add('err');
}

async function startScanner(){
  if(scanning) return;
  show('Requesting camera...');
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' }});
    video.srcObject = stream;
    await video.play();
    scanning = true;
    show('Point camera to VIP QR...');
    tick();
  }catch(e){
    show('Camera error: ' + (e.message||e.name), false);
    logMsg('camera error', e);
  }
}

function stopScanner(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  scanning=false;
}

async function sendToServer(payload){
  try{
    const r = await fetch(BACKEND + '/vipvalidate', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload),
      cache: 'no-store'
    });
    const data = await r.json();
    logMsg('server:', JSON.stringify(data));
    if(data.status === 'ok'){
      show(data.msg, true);
    } else {
      show(data.msg || '❌ '+(data.status||'error'), false);
    }
  }catch(err){
    show('Network error', false);
    logMsg('fetch error', err);
  }
}

function tryParseScanned(text){
  // prefer JSON {name,role}
  try {
    const parsed = JSON.parse(text);
    if(parsed && parsed.name){
      return { name: parsed.name, role: parsed.role || '' };
    }
  } catch(e){}
  // fallback: treat whole text as name
  return { name: text, role: '' };
}

function tick(){
  if(!scanning) return;
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(img.data, img.width, img.height, { inversionAttempts: "dontInvert" });
    if(code){
      logMsg('scanned raw:', code.data);
      stopScanner();
      const parsed = tryParseScanned(code.data.trim());
      // send either {name, role} or {qr: raw} so server can parse as needed
      if(parsed.role) {
        sendToServer({ name: parsed.name, role: parsed.role });
      } else {
        // name only
        sendToServer({ name: parsed.name });
      }
      return;
    }
  }
  requestAnimationFrame(tick);
}

startBtn.addEventListener('click', ()=>{
  show('Starting camera...');
  startScanner();
});
</script>
</body>
</html>
